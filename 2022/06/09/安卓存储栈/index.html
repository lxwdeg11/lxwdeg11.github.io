<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>安卓存储栈 | 莫失莫忘的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="安卓软件栈 framework层StorageManager 1frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;os&#x2F;storage&#x2F;StorageManager.java  java libcore——位于Android runtime里的core libraries According to this slide deck from 2016, Libcore is Goo">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓存储栈">
<meta property="og:url" content="http://example.com/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/index.html">
<meta property="og:site_name" content="莫失莫忘的博客">
<meta property="og:description" content="安卓软件栈 framework层StorageManager 1frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;os&#x2F;storage&#x2F;StorageManager.java  java libcore——位于Android runtime里的core libraries According to this slide deck from 2016, Libcore is Goo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://developer.android.com/guide/platform/images/android-stack_2x.png?hl=zh-cn">
<meta property="article:published_time" content="2022-06-09T13:35:01.000Z">
<meta property="article:modified_time" content="2022-06-09T13:52:20.666Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Storage">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.com/guide/platform/images/android-stack_2x.png?hl=zh-cn">
  
    <link rel="alternate" href="/atom.xml" title="莫失莫忘的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">莫失莫忘的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-安卓存储栈" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/" class="article-date">
  <time datetime="2022-06-09T13:35:01.000Z" itemprop="datePublished">2022-06-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      安卓存储栈
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安卓软件栈"><a href="#安卓软件栈" class="headerlink" title="安卓软件栈"></a>安卓软件栈</h3><p><img src="https://developer.android.com/guide/platform/images/android-stack_2x.png?hl=zh-cn" alt="Android 软件堆栈"></p>
<h3 id="framework层"><a href="#framework层" class="headerlink" title="framework层"></a>framework层</h3><p>StorageManager</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/storage/StorageManager.java</span><br></pre></td></tr></table></figure>

<h3 id="java-libcore——位于Android-runtime里的core-libraries"><a href="#java-libcore——位于Android-runtime里的core-libraries" class="headerlink" title="java libcore——位于Android runtime里的core libraries"></a>java libcore——位于Android runtime里的core libraries</h3><blockquote>
<p>According to this slide deck from 2016, Libcore is Google’s implementation of some core Java libraries such as java.net, java.util, java.icu (Unicode), java.math, java.reflect, and possibly more. Libcore also allows for POSIX system calls from Java.Libcore’s master branch can be found here. Most of Google’s implementation is found in folder luni , but libcore also mixes with Oracle code. For example, Oracle’s JNI implementation from OpenJDK is used in Android in folder ojluni. So libcore replaces some functionality from OpenJDK, but not all.<br><strong>有个java.io.file在路径：</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/java/java/io/File.java</span><br></pre></td></tr></table></figure>
<p><strong>framework层是调用上面的这个File.java类吗？不是？</strong></p>
<p>里面有文件相关操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public boolean createNewFile() throws IOException &#123;</span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        if (security != null) security.checkWrite(path);</span><br><span class="line">        if (isInvalid()) &#123;</span><br><span class="line">            throw new IOException(&quot;Invalid file path&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return fs.createFileExclusively(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/* -- File operations -- */</span><br><span class="line">    // Android-changed: Add method to intercept native method call; BlockGuard support.</span><br><span class="line">    public boolean createFileExclusively(String path) throws IOException &#123;</span><br><span class="line">        BlockGuard.getThreadPolicy().onWriteToDisk();</span><br><span class="line">        BlockGuard.getVmPolicy().onPathAccess(path);</span><br><span class="line">        return createFileExclusively0(path);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>这里是C语言实现的给java调用的createFileExclusively0 JNI接口：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/native/UnixFileSystem_md.c：</span><br><span class="line"></span><br><span class="line">// Android-changed: Name changed because of added thread policy check</span><br><span class="line">JNIEXPORT jboolean JNICALL</span><br><span class="line">Java_java_io_UnixFileSystem_createFileExclusively0(JNIEnv *env, jclass cls,</span><br><span class="line">                                                   jstring pathname)</span><br><span class="line">&#123;</span><br><span class="line">    jboolean rv = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    WITH_PLATFORM_STRING(env, pathname, path) &#123;</span><br><span class="line">        FD fd;</span><br><span class="line">        /* The root directory always exists */</span><br><span class="line">        if (strcmp (path, &quot;/&quot;)) &#123;</span><br><span class="line">            fd = handleOpen(path, O_RDWR | O_CREAT | O_EXCL, 0666);</span><br><span class="line">            if (fd &lt; 0) &#123;</span><br><span class="line">                if (errno != EEXIST)</span><br><span class="line">                    JNU_ThrowIOExceptionWithLastError(env, path);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (close(fd) == -1)</span><br><span class="line">                    JNU_ThrowIOExceptionWithLastError(env, path);</span><br><span class="line">                rv = JNI_TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; END_PLATFORM_STRING(env, path);</span><br><span class="line">    return rv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">libcore/ojluni/src/main/native/io_util_md.c：</span><br><span class="line">FD</span><br><span class="line">handleOpen(const char *path, int oflag, int mode) &#123;</span><br><span class="line">    FD fd;</span><br><span class="line">    RESTARTABLE(open64(path, oflag, mode), fd);</span><br><span class="line">    if (fd != -1) &#123;</span><br><span class="line">        struct stat64 buf64;</span><br><span class="line">        int result;</span><br><span class="line">        RESTARTABLE(fstat64(fd, &amp;buf64), result);</span><br><span class="line">        if (result != -1) &#123;</span><br><span class="line">            if (S_ISDIR(buf64.st_mode)) &#123;</span><br><span class="line">                close(fd);</span><br><span class="line">                errno = EISDIR;</span><br><span class="line">                fd = -1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bionic/libc/include/bits/fortify/fcntl.h：</span><br><span class="line">__BIONIC_FORTIFY_INLINE</span><br><span class="line">int open64(const char* const __pass_object_size pathname, int flags, mode_t modes)</span><br><span class="line">        __overloadable</span><br><span class="line">        __clang_warning_if(!__open_modes_useful(flags) &amp;&amp; modes,</span><br><span class="line">                           &quot;&#x27;open64&#x27; &quot; __open_useless_modes_warning) &#123;</span><br><span class="line">    return open(pathname, flags, modes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__BIONIC_FORTIFY_INLINE</span><br><span class="line">int open(const char* const __pass_object_size pathname, int flags, mode_t modes)</span><br><span class="line">        __overloadable</span><br><span class="line">        __clang_warning_if(!__open_modes_useful(flags) &amp;&amp; modes,</span><br><span class="line">                           &quot;&#x27;open&#x27; &quot; __open_useless_modes_warning) &#123;</span><br><span class="line">    return __open_real(pathname, flags, modes);</span><br><span class="line">&#125;</span><br><span class="line">int __open_real(const char*, int, ...) __RENAME(open);</span><br><span class="line"></span><br><span class="line">bionic/libc/include/sys/cdefs.h：</span><br><span class="line">#define __RENAME(x) __asm__(#x)</span><br></pre></td></tr></table></figure>
<p>看这两个文件：<br>libcore\luni\src\main\native\libcore_io_Posix.cpp<br>libcore\luni\src\main\native\libcore_io_Linux.cpp</p>
<p>另外一个类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java：</span><br><span class="line">public class ContextWrapper extends Context &#123;</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    Context mBase;</span><br><span class="line"></span><br><span class="line">    public ContextWrapper(Context base) &#123;</span><br><span class="line">        mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public FileInputStream openFileInput(String name)</span><br><span class="line">            throws FileNotFoundException &#123;</span><br><span class="line">        return mBase.openFileInput(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/ContextImpl.java：</span><br><span class="line"> @Override</span><br><span class="line">    public FileInputStream openFileInput(String name)</span><br><span class="line">        throws FileNotFoundException &#123;</span><br><span class="line">        File f = makeFilename(getFilesDir(), name);</span><br><span class="line">        return new FileInputStream(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">这个对象FileInputStream：</span><br><span class="line">public FileInputStream(String name)</span><br><span class="line">                throws FileNotFoundException</span><br><span class="line">Creates a FileInputStream by opening a connection to an actual file, the file named by the path name name in the file system. A new FileDescriptor object is created to represent this file connection.</span><br><span class="line">其中的几个方法：</span><br><span class="line">public int read() 从输入流读一个字节的数据</span><br><span class="line">         throws IOException</span><br><span class="line">Reads a byte of data from this input stream. This method blocks if no input is yet available.</span><br><span class="line"></span><br><span class="line">public int read(byte[] b)</span><br><span class="line">         throws IOException</span><br><span class="line">Reads up to b.length bytes of data from this input stream into an array of bytes. This method blocks until some input is available.</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">     * Reads up to &lt;code&gt;len&lt;/code&gt; bytes of data from this input stream</span><br><span class="line">     * into an array of bytes. If &lt;code&gt;len&lt;/code&gt; is not zero, the method</span><br><span class="line">     * blocks until some input is available; otherwise, no</span><br><span class="line">     * bytes are read and &lt;code&gt;0&lt;/code&gt; is returned.</span><br><span class="line">     *</span><br><span class="line">     * @param      b     the buffer into which the data is read.</span><br><span class="line">     * @param      off   the start offset in the destination array &lt;code&gt;b&lt;/code&gt;</span><br><span class="line">     * @param      len   the maximum number of bytes read.</span><br><span class="line">     * @return     the total number of bytes read into the buffer, or</span><br><span class="line">     *             &lt;code&gt;-1&lt;/code&gt; if there is no more data because the end of</span><br><span class="line">     *             the file has been reached.</span><br><span class="line">     * @exception  NullPointerException If &lt;code&gt;b&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;.</span><br><span class="line">     * @exception  IndexOutOfBoundsException If &lt;code&gt;off&lt;/code&gt; is negative,</span><br><span class="line">     * &lt;code&gt;len&lt;/code&gt; is negative, or &lt;code&gt;len&lt;/code&gt; is greater than</span><br><span class="line">     * &lt;code&gt;b.length - off&lt;/code&gt;</span><br><span class="line">     * @exception  IOException  if an I/O error occurs.</span><br><span class="line">     */</span><br><span class="line">    public int read(byte b[], int off, int len) throws IOException &#123;</span><br><span class="line">        // Android-added: close() check before I/O.</span><br><span class="line">        if (closed &amp;&amp; len &gt; 0) &#123;</span><br><span class="line">            throw new IOException(&quot;Stream Closed&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Android-added: Tracking of unbuffered I/O.</span><br><span class="line">        tracker.trackIo(len, IoTracker.Mode.READ);</span><br><span class="line"></span><br><span class="line">        // Android-changed: Use IoBridge instead of calling native method.</span><br><span class="line">        return IoBridge.read(fd, b, off, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/native/io_util.c:</span><br><span class="line"></span><br><span class="line">jint</span><br><span class="line">readBytes(JNIEnv *env, jobject this, jbyteArray bytes,</span><br><span class="line">          jint off, jint len, jfieldID fid)</span><br><span class="line">&#123;</span><br><span class="line">    jint nread;</span><br><span class="line">    char stackBuf[BUF_SIZE];</span><br><span class="line">    char *buf = NULL;</span><br><span class="line">    FD fd;</span><br><span class="line"></span><br><span class="line">    if (IS_NULL(bytes)) &#123;</span><br><span class="line">        JNU_ThrowNullPointerException(env, NULL);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (outOfBounds(env, off, len, bytes)) &#123;</span><br><span class="line">        JNU_ThrowByName(env, &quot;java/lang/IndexOutOfBoundsException&quot;, NULL);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (len == 0) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125; else if (len &gt; BUF_SIZE) &#123;</span><br><span class="line">        buf = malloc(len);</span><br><span class="line">        if (buf == NULL) &#123;</span><br><span class="line">            JNU_ThrowOutOfMemoryError(env, NULL);</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        buf = stackBuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = GET_FD(this, fid);</span><br><span class="line">    if (fd == -1) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, &quot;Stream Closed&quot;);</span><br><span class="line">        nread = -1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        nread = (jint)IO_Read(fd, buf, len);</span><br><span class="line">        if (nread &gt; 0) &#123;</span><br><span class="line">            (*env)-&gt;SetByteArrayRegion(env, bytes, off, nread, (jbyte *)buf);</span><br><span class="line">        &#125; else if (nread == JVM_IO_ERR) &#123;</span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, &quot;Read error&quot;);</span><br><span class="line">        &#125; else if (nread == JVM_IO_INTR) &#123;</span><br><span class="line">            JNU_ThrowByName(env, &quot;java/io/InterruptedIOException&quot;, NULL);</span><br><span class="line">        &#125; else &#123; /* EOF */</span><br><span class="line">            nread = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (buf != stackBuf) &#123;</span><br><span class="line">        free(buf);</span><br><span class="line">    &#125;</span><br><span class="line">    return nread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">libcore/ojluni/src/main/native/io_util_md.h:</span><br><span class="line">#define IO_Read JVM_Read</span><br><span class="line"></span><br><span class="line">art/openjdkjvm/OpenjdkJvm.cc:</span><br><span class="line">/* posix read() */</span><br><span class="line">JNIEXPORT jint JVM_Read(jint fd, char* buf, jint nbytes) &#123;</span><br><span class="line">    return TEMP_FAILURE_RETRY(read(fd, buf, nbytes));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>






<h3 id="libc库"><a href="#libc库" class="headerlink" title="libc库"></a>libc库</h3><p>源码位置：<br><code>bionic/libc/stdio/stdio.cpp</code></p>
<p>上层不一定调用fopen，可能直接调open系统调用。<br>例如fopen：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FILE* fopen(const char* file, const char* mode) &#123;</span><br><span class="line">  int mode_flags;</span><br><span class="line">  int flags = __sflags(mode, &amp;mode_flags);</span><br><span class="line">  if (flags == 0) return nullptr;</span><br><span class="line"></span><br><span class="line">  int fd = open(file, mode_flags, DEFFILEMODE);</span><br><span class="line">  if (fd == -1) &#123;</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FILE* fp = __FILE_init(__sfp(), fd, flags);</span><br><span class="line">  if (fp == nullptr) &#123;</span><br><span class="line">    ErrnoRestorer errno_restorer;</span><br><span class="line">    close(fd);</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>里面的open就会最终调用到open系统调用。<br>libc里面调用的系统调用，根据这个文件里的系统调用列表，会用python脚本生成头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//android.googlesource.com/platform/bionic/+/refs/heads/master/libc/SYSCALLS.TXT</span></span><br><span class="line"></span><br><span class="line"># This file is used to automatically generate bionic<span class="number">&#x27;</span>s system call stubs.</span><br><span class="line">#</span><br><span class="line"># Each non-blank, non-comment line has the following format:</span><br><span class="line">#</span><br><span class="line"># return_type func_name[|alias_list][:syscall_name[:socketcall_id]]([parameter_list]) arch_list</span><br><span class="line">#</span><br><span class="line"><span class="meta"># where:</span></span><br><span class="line">#       arch_list ::= <span class="string">&quot;all&quot;</span> | arches</span><br><span class="line"><span class="meta">#       arches    ::= arch |  arch <span class="string">&quot;,&quot;</span> arches</span></span><br><span class="line"><span class="meta">#       arch      ::= <span class="string">&quot;arm&quot;</span> | <span class="string">&quot;arm64&quot;</span> | <span class="string">&quot;x86&quot;</span> | <span class="string">&quot;x86_64&quot;</span> | <span class="string">&quot;lp32&quot;</span> | <span class="string">&quot;lp64&quot;</span></span></span><br><span class="line">#</span><br><span class="line"># Note:</span><br><span class="line">#      - syscall_name corresponds to the name of the syscall, which may differ from</span><br><span class="line"><span class="meta">#        the exported function name (example: the exit syscall is implemented by the _exit()</span></span><br><span class="line"><span class="meta">#        function, which is not the same as the standard C exit() function which calls it)</span></span><br><span class="line">#</span><br><span class="line">#      - alias_list is optional comma separated <span class="built_in">list</span> of function aliases.</span><br><span class="line">#</span><br><span class="line">#      - The call_id parameter, given that func_name and syscall_name have</span><br><span class="line"><span class="meta">#        been provided, allows the user to specify dispatch style syscalls.</span></span><br><span class="line">#        For example, socket() syscall on i386 actually becomes:</span><br><span class="line"><span class="meta">#          socketcall(__NR_socket, 1, *(rest of args on stack)).</span></span><br><span class="line">#</span><br><span class="line">#      - Each parameter type is assumed to be stored in <span class="number">32</span> bits.</span><br><span class="line">#</span><br><span class="line"># This file is processed by a python script named gensyscalls.py, run via</span><br><span class="line"><span class="meta"># genrules in Android.bp.</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/" data-id="cl472cilf0000dkvk0ufwhatk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Storage/" rel="tag">Storage</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/06/11/5W2H%E5%AD%A6%E4%B9%A0%E4%B8%80%E9%A1%B9%E6%8A%80%E6%9C%AF/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          如何学习一项技术
        
      </div>
    </a>
  
  
    <a href="/2022/05/29/Linux-kernel-news/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Linux kernel news</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/">安卓开发</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Arm64/" rel="tag">Arm64</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Busybox/" rel="tag">Busybox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hello-World/" rel="tag">Hello World</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/" rel="tag">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pycharm/" rel="tag">Pycharm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/" rel="tag">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storage/" rel="tag">Storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/adb/" rel="tag">adb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edge/" rel="tag">edge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/for-test/" rel="tag">for test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftpd/" rel="tag">ftpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo%E7%AE%A1%E7%90%86/" rel="tag">hexo管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/httpd/" rel="tag">httpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pyinstaller/" rel="tag">pyinstaller</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/storage/" rel="tag">storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/websocket/" rel="tag">websocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wss/" rel="tag">wss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%9B%98/" rel="tag">网盘</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Arm64/" style="font-size: 10px;">Arm64</a> <a href="/tags/Busybox/" style="font-size: 10px;">Busybox</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">C语言</a> <a href="/tags/Hello-World/" style="font-size: 16.67px;">Hello World</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Javascript/" style="font-size: 10px;">Javascript</a> <a href="/tags/Pycharm/" style="font-size: 10px;">Pycharm</a> <a href="/tags/Python/" style="font-size: 13.33px;">Python</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/Storage/" style="font-size: 10px;">Storage</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/edge/" style="font-size: 10px;">edge</a> <a href="/tags/for-test/" style="font-size: 10px;">for test</a> <a href="/tags/ftpd/" style="font-size: 10px;">ftpd</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo%E7%AE%A1%E7%90%86/" style="font-size: 10px;">hexo管理</a> <a href="/tags/httpd/" style="font-size: 10px;">httpd</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/pyinstaller/" style="font-size: 10px;">pyinstaller</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/storage/" style="font-size: 10px;">storage</a> <a href="/tags/websocket/" style="font-size: 13.33px;">websocket</a> <a href="/tags/wss/" style="font-size: 10px;">wss</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 10px;">杂谈</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 10px;">浏览器</a> <a href="/tags/%E7%BD%91%E7%9B%98/" style="font-size: 10px;">网盘</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/06/30/qemu%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/22/ufs%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E7%96%91%E9%97%AE/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/11/%E5%AE%89%E5%8D%93%E4%BD%BF%E7%94%A8FUSE/">安卓使用FUSE</a>
          </li>
        
          <li>
            <a href="/2022/06/11/5W2H%E5%AD%A6%E4%B9%A0%E4%B8%80%E9%A1%B9%E6%8A%80%E6%9C%AF/">如何学习一项技术</a>
          </li>
        
          <li>
            <a href="/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/">安卓存储栈</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
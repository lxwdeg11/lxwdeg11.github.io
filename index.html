<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>莫失莫忘的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="莫失莫忘的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="莫失莫忘的博客">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="莫失莫忘的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">莫失莫忘的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-压缩文件夹，同时加密文件名" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/17/%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E5%90%8D/" class="article-date">
  <time datetime="2022-07-17T00:46:21.000Z" itemprop="datePublished">2022-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/17/%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E5%90%8D/">压缩文件夹，同时加密文件名</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Ubuntu上用7z"><a href="#Ubuntu上用7z" class="headerlink" title="Ubuntu上用7z"></a>Ubuntu上用7z</h2><ul>
<li>ubuntu下，先安装7z。</li>
<li>在要压缩的文件夹里面，</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7z a -r -p -mhe=on ../folder.7z</span><br></pre></td></tr></table></figure>

<h2 id="windows上用WinRAR"><a href="#windows上用WinRAR" class="headerlink" title="windows上用WinRAR"></a>windows上用WinRAR</h2><p><img src="image-20220717085115492.png" alt="image-20220717085115492"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/17/%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E5%90%8D/" data-id="cl5olrbom0001akvk9kpeb2zn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Ubuntu更换源" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/01/Ubuntu%E6%9B%B4%E6%8D%A2%E6%BA%90/" class="article-date">
  <time datetime="2022-07-01T12:11:53.000Z" itemprop="datePublished">2022-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/01/Ubuntu%E6%9B%B4%E6%8D%A2%E6%BA%90/">Ubuntu更换源</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/01/Ubuntu%E6%9B%B4%E6%8D%A2%E6%BA%90/" data-id="cl5olrboa0000akvk6xszdeqy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qemu从源码编译" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/30/qemu%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" class="article-date">
  <time datetime="2022-06-30T14:49:47.777Z" itemprop="datePublished">2022-06-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>基于Ubuntu</p>
<p>安装依赖包：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git libglib2<span class="number">.0</span>-dev libfdt-dev libpixman<span class="number">-1</span>-dev zlib1g-dev ninja-build</span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//mirrors.tuna.tsinghua.edu.cn/git/qemu.git</span></span><br><span class="line">cd qemu</span><br><span class="line">mkdir -p bin/debug/native</span><br><span class="line">cd bin/debug/native</span><br><span class="line">../../../configure --enable-debug --target-<span class="built_in">list</span>=aarch64-softmmu</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/30/qemu%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" data-id="cl515pspv0000vwvkhg5h3y1m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ufs内核代码疑问" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/22/ufs%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E7%96%91%E9%97%AE/" class="article-date">
  <time datetime="2022-06-22T14:17:52.105Z" itemprop="datePublished">2022-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="struct-scsi-driver-ufs-dev-wlun-template如何与struct-scsi-device-sdev-ufs-device匹配"><a href="#struct-scsi-driver-ufs-dev-wlun-template如何与struct-scsi-device-sdev-ufs-device匹配" class="headerlink" title="struct scsi_driver ufs_dev_wlun_template如何与struct scsi_device *sdev_ufs_device匹配"></a>struct scsi_driver ufs_dev_wlun_template如何与struct scsi_device *sdev_ufs_device匹配</h1><p>device在寻找匹配他的driver的时候，会遍历device所属bus的所有driver，尝试调用driver的probe函数，如果probe函数返回成功，则就认为这个driver是这个device匹配的driver。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">static int __device_attach(struct device *dev, bool allow_async)</span><br><span class="line">&#123;</span><br><span class="line">	int ret = 0;</span><br><span class="line"></span><br><span class="line">	device_lock(dev);</span><br><span class="line">	if (dev-&gt;p-&gt;dead) &#123;</span><br><span class="line">		goto out_unlock;</span><br><span class="line">	&#125; else if (dev-&gt;driver) &#123;</span><br><span class="line">		if (device_is_bound(dev)) &#123;</span><br><span class="line">			ret = 1;</span><br><span class="line">			goto out_unlock;</span><br><span class="line">		&#125;</span><br><span class="line">		ret = device_bind_driver(dev);</span><br><span class="line">		if (ret == 0)</span><br><span class="line">			ret = 1;</span><br><span class="line">		else &#123;</span><br><span class="line">			dev-&gt;driver = NULL;</span><br><span class="line">			ret = 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		struct device_attach_data data = &#123;</span><br><span class="line">			.dev = dev,</span><br><span class="line">			.check_async = allow_async,</span><br><span class="line">			.want_async = false,</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		if (dev-&gt;parent)</span><br><span class="line">			pm_runtime_get_sync(dev-&gt;parent);</span><br><span class="line"></span><br><span class="line">		ret = bus_for_each_drv(dev-&gt;bus, NULL, &amp;data,</span><br><span class="line">					__device_attach_driver);//这里开始遍历bus下面的driver，调用driver的probe函数成功，就是该device对应的driver。</span><br><span class="line">		if (!ret &amp;&amp; allow_async &amp;&amp; data.have_async) &#123;</span><br><span class="line">			/*</span><br><span class="line">			 * If we could not find appropriate driver</span><br><span class="line">			 * synchronously and we are allowed to do</span><br><span class="line">			 * async probes and there are drivers that</span><br><span class="line">			 * want to probe asynchronously, we&#x27;ll</span><br><span class="line">			 * try them.</span><br><span class="line">			 */</span><br><span class="line">			dev_dbg(dev, &quot;scheduling asynchronous probe\n&quot;);</span><br><span class="line">			get_device(dev);</span><br><span class="line">			async_schedule_dev(__device_attach_async_helper, dev);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			pm_request_idle(dev);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (dev-&gt;parent)</span><br><span class="line">			pm_runtime_put(dev-&gt;parent);</span><br><span class="line">	&#125;</span><br><span class="line">out_unlock:</span><br><span class="line">	device_unlock(dev);</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * bus_for_each_drv - driver iterator</span><br><span class="line"> * @bus: bus we&#x27;re dealing with.</span><br><span class="line"> * @start: driver to start iterating on.</span><br><span class="line"> * @data: data to pass to the callback.</span><br><span class="line"> * @fn: function to call for each driver.</span><br><span class="line"> *</span><br><span class="line"> * This is nearly identical to the device iterator above.</span><br><span class="line"> * We iterate over each driver that belongs to @bus, and call</span><br><span class="line"> * @fn for each. If @fn returns anything but 0, we break out</span><br><span class="line"> * and return it. If @start is not NULL, we use it as the head</span><br><span class="line"> * of the list.</span><br><span class="line"> *</span><br><span class="line"> * NOTE: we don&#x27;t return the driver that returns a non-zero</span><br><span class="line"> * value, nor do we leave the reference count incremented for that</span><br><span class="line"> * driver. If the caller needs to know that info, it must set it</span><br><span class="line"> * in the callback. It must also be sure to increment the refcount</span><br><span class="line"> * so it doesn&#x27;t disappear before returning to the caller.</span><br><span class="line"> */</span><br><span class="line">int bus_for_each_drv(struct bus_type *bus, struct device_driver *start,</span><br><span class="line">		     void *data, int (*fn)(struct device_driver *, void *))</span><br><span class="line">&#123;</span><br><span class="line">	struct klist_iter i;</span><br><span class="line">	struct device_driver *drv;</span><br><span class="line">	int error = 0;</span><br><span class="line"></span><br><span class="line">	if (!bus)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	klist_iter_init_node(&amp;bus-&gt;p-&gt;klist_drivers, &amp;i,</span><br><span class="line">			     start ? &amp;start-&gt;p-&gt;knode_bus : NULL);</span><br><span class="line">	while ((drv = next_driver(&amp;i)) &amp;&amp; !error)</span><br><span class="line">		error = fn(drv, data);</span><br><span class="line">	klist_iter_exit(&amp;i);</span><br><span class="line">	return error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn为__device_attach_driver</span><br><span class="line">static int __device_attach_driver(struct device_driver *drv, void *_data)</span><br><span class="line">&#123;</span><br><span class="line">	struct device_attach_data *data = _data;</span><br><span class="line">	struct device *dev = data-&gt;dev;</span><br><span class="line">	bool async_allowed;</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	ret = driver_match_device(drv, dev);</span><br><span class="line">	if (ret == 0) &#123;</span><br><span class="line">		/* no match */</span><br><span class="line">		return 0;</span><br><span class="line">	&#125; else if (ret == -EPROBE_DEFER) &#123;</span><br><span class="line">		dev_dbg(dev, &quot;Device match requests probe deferral\n&quot;);</span><br><span class="line">		dev-&gt;can_match = true;</span><br><span class="line">		driver_deferred_probe_add(dev);</span><br><span class="line">	&#125; else if (ret &lt; 0) &#123;</span><br><span class="line">		dev_dbg(dev, &quot;Bus failed to match device: %d\n&quot;, ret);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125; /* ret &gt; 0 means positive match */</span><br><span class="line"></span><br><span class="line">	async_allowed = driver_allows_async_probing(drv);</span><br><span class="line"></span><br><span class="line">	if (async_allowed)</span><br><span class="line">		data-&gt;have_async = true;</span><br><span class="line"></span><br><span class="line">	if (data-&gt;check_async &amp;&amp; async_allowed != data-&gt;want_async)</span><br><span class="line">		return 0;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Ignore errors returned by -&gt;probe so that the next driver can try</span><br><span class="line">	 * its luck.</span><br><span class="line">	 */</span><br><span class="line">	ret = driver_probe_device(drv, dev);</span><br><span class="line">	if (ret &lt; 0)</span><br><span class="line">		return ret;</span><br><span class="line">	return ret == 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * driver_probe_device - attempt to bind device &amp; driver together</span><br><span class="line"> * @drv: driver to bind a device to</span><br><span class="line"> * @dev: device to try to bind to the driver</span><br><span class="line"> *</span><br><span class="line"> * This function returns -ENODEV if the device is not registered, -EBUSY if it</span><br><span class="line"> * already has a driver, 0 if the device is bound successfully and a positive</span><br><span class="line"> * (inverted) error code for failures from the -&gt;probe method.</span><br><span class="line"> *</span><br><span class="line"> * This function must be called with @dev lock held.  When called for a</span><br><span class="line"> * USB interface, @dev-&gt;parent lock must be held as well.</span><br><span class="line"> *</span><br><span class="line"> * If the device has a parent, runtime-resume the parent before driver probing.</span><br><span class="line"> */</span><br><span class="line">static int driver_probe_device(struct device_driver *drv, struct device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	int trigger_count = atomic_read(&amp;deferred_trigger_count);</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	atomic_inc(&amp;probe_count);</span><br><span class="line">	ret = __driver_probe_device(drv, dev);</span><br><span class="line">	if (ret == -EPROBE_DEFER || ret == EPROBE_DEFER) &#123;</span><br><span class="line">		driver_deferred_probe_add(dev);</span><br><span class="line"></span><br><span class="line">		/*</span><br><span class="line">		 * Did a trigger occur while probing? Need to re-trigger if yes</span><br><span class="line">		 */</span><br><span class="line">		if (trigger_count != atomic_read(&amp;deferred_trigger_count) &amp;&amp;</span><br><span class="line">		    !defer_all_probes)</span><br><span class="line">			driver_deferred_probe_trigger();</span><br><span class="line">	&#125;</span><br><span class="line">	atomic_dec(&amp;probe_count);</span><br><span class="line">	wake_up_all(&amp;probe_waitqueue);</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__driver_probe_device -&gt; really_probe -&gt; call_driver_probe</span><br><span class="line">static int call_driver_probe(struct device *dev, struct device_driver *drv)</span><br><span class="line">&#123;</span><br><span class="line">	int ret = 0;</span><br><span class="line"></span><br><span class="line">	if (dev-&gt;bus-&gt;probe)//scsi_bus_type没有probe函数</span><br><span class="line">		ret = dev-&gt;bus-&gt;probe(dev);</span><br><span class="line">	else if (drv-&gt;probe)</span><br><span class="line">		ret = drv-&gt;probe(dev);</span><br><span class="line"></span><br><span class="line">	switch (ret) &#123;</span><br><span class="line">	case 0:</span><br><span class="line">		break;</span><br><span class="line">	case -EPROBE_DEFER:</span><br><span class="line">		/* Driver requested deferred probing */</span><br><span class="line">		dev_dbg(dev, &quot;Driver %s requests probe deferral\n&quot;, drv-&gt;name);</span><br><span class="line">		break;</span><br><span class="line">	case -ENODEV:</span><br><span class="line">	case -ENXIO:</span><br><span class="line">		pr_debug(&quot;%s: probe of %s rejects match %d\n&quot;,</span><br><span class="line">			 drv-&gt;name, dev_name(dev), ret);</span><br><span class="line">		break;</span><br><span class="line">	default:</span><br><span class="line">		/* driver matched but the probe failed */</span><br><span class="line">		pr_warn(&quot;%s: probe of %s failed with error %d\n&quot;,</span><br><span class="line">			drv-&gt;name, dev_name(dev), ret);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct bus_type scsi_bus_type = &#123;</span><br><span class="line">        .name		= &quot;scsi&quot;,</span><br><span class="line">        .match		= scsi_bus_match,</span><br><span class="line">	.uevent		= scsi_bus_uevent,</span><br><span class="line">#ifdef CONFIG_PM</span><br><span class="line">	.pm		= &amp;scsi_bus_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>而struct scsi_driver ufs_dev_wlun_template的probe函数，只有对ufs device wlun的scsi device，才会返回成功：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ufshcd_wl_probe</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scsi_device</span> *<span class="title">sdev</span> =</span> to_scsi_device(dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!is_device_wlun(sdev))</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">	blk_pm_runtime_init(sdev-&gt;request_queue, dev);</span><br><span class="line">	pm_runtime_set_autosuspend_delay(dev, <span class="number">0</span>);</span><br><span class="line">	pm_runtime_allow(dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ufs device wlun跑别的scsi_driver的probe函数会失败，比如sd_template的sd_probe，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sd_probe</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scsi_device</span> *<span class="title">sdp</span> =</span> to_scsi_device(dev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scsi_disk</span> *<span class="title">sdkp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *<span class="title">gd</span>;</span></span><br><span class="line">	<span class="type">int</span> index;</span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">	scsi_autopm_get_device(sdp);</span><br><span class="line">	error = -ENODEV;</span><br><span class="line">	<span class="keyword">if</span> (sdp-&gt;type != TYPE_DISK &amp;&amp;</span><br><span class="line">	    sdp-&gt;type != TYPE_ZBC &amp;&amp;</span><br><span class="line">	    sdp-&gt;type != TYPE_MOD &amp;&amp;</span><br><span class="line">	    sdp-&gt;type != TYPE_RBC)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">		......</span><br></pre></td></tr></table></figure>

<p>scsi_probe_and_add_lun会发送inquiry命令，根据inquiry命令返回结果，可以知道scsi device的类型，disk类型为0x0，wlun类型为0x1E，从而wlun调用sd_probe会判断sdp-&gt;type设备类型失败。</p>
<p>看代码打印，ufshcd_wl_probe被多个scsi device匹配driver过程中都调用了：</p>
<p><img src="D:%5Cappdata%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220625201229376.png" alt="image-20220625201229376"></p>
<p><img src="../../../../../appdata/Roaming/Typora/typora-user-images/image-20220625201319863.png" alt="image-20220625201319863"></p>
<p><img src="image-20220625201452297.png" alt="image-20220625201452297"></p>
<h1 id="sd-template这个driver是如何绑定到ufs-not-well-known-lu-scsi-device的"><a href="#sd-template这个driver是如何绑定到ufs-not-well-known-lu-scsi-device的" class="headerlink" title="sd_template这个driver是如何绑定到ufs not well known lu scsi device的"></a>sd_template这个driver是如何绑定到ufs not well known lu scsi device的</h1><p>机制类似上面，ufs not well known lu scsi device跑ufs_dev_wlun_template这个driver的ufshcd_wl_probe会失败，跑sd_template这个driver的sd_probe时成功，所以绑定driver为sd_template。</p>
<h1 id="scsi-bus-suspend-common后blk-set-pm-only那么，sync-cache怎么发送"><a href="#scsi-bus-suspend-common后blk-set-pm-only那么，sync-cache怎么发送" class="headerlink" title="scsi_bus_suspend_common后blk set pm only那么，sync cache怎么发送"></a>scsi_bus_suspend_common后blk set pm only那么，sync cache怎么发送</h1><p>sync cache带RQF_PM标记，blk set pm only设置后，可以发送带RQF_PM标记的请求</p>
<h1 id="kthread-run有哪些？"><a href="#kthread-run有哪些？" class="headerlink" title="kthread_run有哪些？"></a>kthread_run有哪些？</h1><h1 id="shost-gt-tmf-work-q？"><a href="#shost-gt-tmf-work-q？" class="headerlink" title="shost-&gt;tmf_work_q？"></a>shost-&gt;tmf_work_q？</h1><h1 id="scsi各种设备关系？"><a href="#scsi各种设备关系？" class="headerlink" title="scsi各种设备关系？"></a>scsi各种设备关系？</h1><h1 id="scsi-disk，-gendisk？block-device？"><a href="#scsi-disk，-gendisk？block-device？" class="headerlink" title="scsi disk， gendisk？block device？"></a>scsi disk， gendisk？block device？</h1><h1 id="scsi层初始化"><a href="#scsi层初始化" class="headerlink" title="scsi层初始化"></a>scsi层初始化</h1><h2 id="SCSI较高层注册SCSI设备驱动init-sd"><a href="#SCSI较高层注册SCSI设备驱动init-sd" class="headerlink" title="SCSI较高层注册SCSI设备驱动init_sd"></a>SCSI较高层注册SCSI设备驱动init_sd</h2><h2 id="SCSI中间层注册SCSI总线类型init-scsi"><a href="#SCSI中间层注册SCSI总线类型init-scsi" class="headerlink" title="SCSI中间层注册SCSI总线类型init_scsi"></a>SCSI中间层注册SCSI总线类型init_scsi</h2><h2 id="SCSI较低层（SCSI-HBA驱动）则负责扫描SCSI总线得到所有的SCSI设备"><a href="#SCSI较低层（SCSI-HBA驱动）则负责扫描SCSI总线得到所有的SCSI设备" class="headerlink" title="SCSI较低层（SCSI HBA驱动）则负责扫描SCSI总线得到所有的SCSI设备"></a>SCSI较低层（SCSI HBA驱动）则负责扫描SCSI总线得到所有的SCSI设备</h2><h1 id="bus的klist机制？"><a href="#bus的klist机制？" class="headerlink" title="bus的klist机制？"></a>bus的klist机制？</h1><h1 id="device-attach怎么被调用？"><a href="#device-attach怎么被调用？" class="headerlink" title="__device_attach怎么被调用？"></a>__device_attach怎么被调用？</h1><h1 id="scsi-bus下多少driver？"><a href="#scsi-bus下多少driver？" class="headerlink" title="scsi bus下多少driver？"></a>scsi bus下多少driver？</h1><h2 id="dev-wlun跑sd-probe如何会失败"><a href="#dev-wlun跑sd-probe如何会失败" class="headerlink" title="dev wlun跑sd_probe如何会失败?"></a>dev wlun跑sd_probe如何会失败?</h2><h1 id="ufs一路初始化-生成的dev层级结构画图？"><a href="#ufs一路初始化-生成的dev层级结构画图？" class="headerlink" title="ufs一路初始化 生成的dev层级结构画图？"></a>ufs一路初始化 生成的dev层级结构画图？</h1><p>内核各种init运行顺序：module_init subsys_init等</p>
<p>sync cache发送需要RQF_PM标记吗？好像不需要啊？</p>
<h1 id="内核suspend-resume流程，代码，设备suspend-resume代码，父子设备suspend-resume顺序代码？"><a href="#内核suspend-resume流程，代码，设备suspend-resume代码，父子设备suspend-resume顺序代码？" class="headerlink" title="内核suspend resume流程，代码，设备suspend resume代码，父子设备suspend resume顺序代码？"></a>内核suspend resume流程，代码，设备suspend resume代码，父子设备suspend resume顺序代码？</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/22/ufs%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E7%96%91%E9%97%AE/" data-id="cl4pqls7t0000wwvkh1ba45cw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-安卓使用FUSE" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/11/%E5%AE%89%E5%8D%93%E4%BD%BF%E7%94%A8FUSE/" class="article-date">
  <time datetime="2022-06-11T03:38:58.000Z" itemprop="datePublished">2022-06-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/11/%E5%AE%89%E5%8D%93%E4%BD%BF%E7%94%A8FUSE/">安卓使用FUSE</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android使用fuse文件系统来做到灵活的权限管理"><a href="#Android使用fuse文件系统来做到灵活的权限管理" class="headerlink" title="Android使用fuse文件系统来做到灵活的权限管理"></a>Android使用fuse文件系统来做到灵活的权限管理</h1><h2 id="Android对于外置存储权限管理的需求"><a href="#Android对于外置存储权限管理的需求" class="headerlink" title="Android对于外置存储权限管理的需求"></a>Android对于外置存储权限管理的需求</h2><p>Android对于外置存储的管理，需要实现以下几个目标：</p>
<p>1、读写外置存储需要 android.permission.READ_EXTERNAL_STORAGE和android.permission.WRITE_EXTERNAL_STORAGE， 这两个权限是运行时权限，可以动态的授予和撤销， 所以主存储目录的权限管理需要动态支持。</p>
<p>2、主存储目录下的${userid}/Android/obb, ${userid}/Android/data, ${userid}/Android/media 下的应用程序包名目录不需要读写存储卡权限。比如 com.androiud.ss.ugc.aweme这个应用程序读写 ${userid}/Android/data/com.androiud.ss.ugc.aweme 目录是不需要申请权限的。<br>但是不同应用对应的${userid}/Android/data/${package} 目录是权限隔离的，不能相互访问的。</p>
<p>3、除${userid}/Android/obb/${package}目录外，相同应用程序(相同包名)不同用户( ${userid} )的目录也是权限隔离的。但是${userid}/Android/obb/${package}是跨用户( ${userid} ) 共享的。</p>
<h2 id="fuse文件系统作用"><a href="#fuse文件系统作用" class="headerlink" title="fuse文件系统作用"></a>fuse文件系统作用</h2><ul>
<li>灵活的文件位置管理（<strong>路径的转换、映射</strong>）</li>
<li>权限管理</li>
</ul>
<h2 id="FUSE文件系统存在的问题"><a href="#FUSE文件系统存在的问题" class="headerlink" title="FUSE文件系统存在的问题"></a>FUSE文件系统存在的问题</h2><h3 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h3><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9kNGhvWUpseE9qTmliQVNnSEJsQ3BadjFVcU9qVVUyNnRpYXR2TVNXM2dBVThCSU15UE1xUXp3WVlXaWM5ejQwbmlhWnVvVkNYNWpVSThwRGhCQ1hyWUNWMEEvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>具体分析可得每一个读写命令都将经过六次的用户态和内核态的转换：1)用户空间的应用将系统调用传给FUSE内核驱动；2)FUSE内核驱动通知FUSE用户态守护程序有新的操作命令，用户态守护程序从dev/fuse读取命令；3)守护程序分析命令并下传给底层文件系统；4)底层文件系统执行操作，并将数据返回给FUSE守护程序；5)守护程序将结果通过dev/fuse传给FUSE内核驱动；6)FUSE内核驱动将结果返回给上层应用结束。</p>
<h2 id="Android-FUSE实现"><a href="#Android-FUSE实现" class="headerlink" title="Android FUSE实现"></a>Android FUSE实现</h2><p>下面我们拿使用/data分区来模拟主存储的情况进行说明。</p>
<ol>
<li><p>为了实现动态的外置存储权限，Android会挂载三个目录到/dev/fuse来对应同一个外置存储，三个目录分别是/mnt/runtime/default/${label}， /mnt/runtime/read/${label}，/mnt/runtime/write/${label}, 这三个目录代表不同的权限，当一个应用进程取得了读外置存储的权限，那么它将使用 /mnt/runtime/read/${label} 目录来操作外置存储，当一个应用程序取得了写外置存储的权限，那么它将使用/mnt/runtime/write/${label}目录来操作外置存储。当一个应用程序没有获取操作外置存储的权限，将使用/mnt/runtime/default/${label}目录来操作主存储。三个fuse目录最终都会作用于外置存储的media目录，只不过对目录下的可进行的操作权限是不同的。Android 的FUSE file-system daemon会根据应用程序进程使用的fuse目录来决定是否可以读写外置存储的media目录下的数据。</p>
</li>
<li><p><strong>（某个包读取自己${user_id}/Android/data/${package_name} 下目录，如何不需要权限）</strong>通过读取/data/system/packages_list.xml的内容，来维护程序包名和uid的关系，针对外置存储下 ${user_id}/Android 目录的动态权限做处理，基本思路就是当应用程序读写${user_id}/Android/media|obb|data/${package_name} 下文件的时候，把该目录下的文件属主都改成应用程序的uid，作为文件的属主基本上就获得了文件的读写权限，这样应用程序就可以不需要获取外置存储读写权限来读写${user_id}/Android/media|obb|data/${package_name} 下的文件了（因为应用程序就是属主）。</p>
</li>
<li><p>${userid}/Android/obb, ${userid}/Android/data, ${userid}/Android/media 下的${package} 权限管理则根据/data/system/packages.list文件中的内容来完成。 如果一个应用程序操作fuse目录，FUSE file-system daemon处理文件请求的时候可以获取操作文件的进程的uid，并根据/data/system/packages.list下的内容找到uid对应的包名，如果进程操作的包名和uid相对应，则允许操作，否则拒绝操作。</p>
</li>
</ol>
<p>（安卓的不同应用，对应于linux的不同user）</p>
<ol start="4">
<li>不同userid（安卓的不同用户）对应的相同应用的uid不同，根据 2中规则，即可实现 相同应用程序(相同包名)不同用户( ${userid} )的目录的权限隔离。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/20200809102048917.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvYWkxMTAxMjAxMzA=,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<p>如上图所示，Android的sdcard进程中有四个线程， 其中main线程在创建了其他三个线程后调用watch_package_list()函数，来读取/data/system/packages_list.xml文件的内容。sdcard进程通过读取/data/system/packages_list.xml的内容，来维护程序包名和uid的关系，针对外置存储下 ${user_id}/Android 目录的动态权限做处理，基本思路就是当应用程序读写${user_id}/Android/media|obb|data/${package_name} 下文件的时候，把该目录下的文件属主都改成应用程序的uid，作为文件的属主基本上就获得了文件的读写权限，这样应用程序就可以不需要获取外置存储读写权限来读写${user_id}/Android/media|obb|data/${package_name} 下的文件了（因为应用程序就是属主）。</p>
<p>ackages.list文件内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.android.soundrecorder 10021 0 /data/data/com.android.soundrecorder</span><br><span class="line">com.android.sdksetup 10020 0 /data/data/com.android.sdksetup</span><br><span class="line">com.android.launcher 10005 0 /data/data/com.android.launcher</span><br><span class="line">com.android.defcontainer 10009 0 /data/data/com.android.defcontainer</span><br><span class="line">com.android.smoketest 10044 0 /data/data/com.android.smoketest</span><br></pre></td></tr></table></figure>



<pre><code>    其他三个线程，每个线程负责一个fuse目录的读写请求。thread_default线程负责/mnt/runtime/default/$&#123;label&#125; 目录的读写，thread_read 负责 /mnt/runtime/read/$&#123;label&#125;目录的读写， thread_write负责 /mnt/runtime/read/$&#123;label&#125;目录的读写，三个线程都是接收fuse driver的文件操作请求，然后将请求转化为对source_path 文件夹的读写。
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/11/%E5%AE%89%E5%8D%93%E4%BD%BF%E7%94%A8FUSE/" data-id="cl4avabv70001ecvkhj8c7kxt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-5W2H学习一项技术" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/11/5W2H%E5%AD%A6%E4%B9%A0%E4%B8%80%E9%A1%B9%E6%8A%80%E6%9C%AF/" class="article-date">
  <time datetime="2022-06-11T03:23:36.000Z" itemprop="datePublished">2022-06-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/11/5W2H%E5%AD%A6%E4%B9%A0%E4%B8%80%E9%A1%B9%E6%8A%80%E6%9C%AF/">如何学习一项技术</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这项技术</p>
<ul>
<li>是什么？技术核心是什么？ what</li>
<li>是解决什么问题的？为什么其他技术不行？why</li>
<li>是如何解决问题的？（设计思路）how</li>
<li>什么时候用到？when</li>
<li>谁来用这个技术？who</li>
<li>在哪里用到？ where</li>
<li>技术的开销大吗？how much</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/11/5W2H%E5%AD%A6%E4%B9%A0%E4%B8%80%E9%A1%B9%E6%8A%80%E6%9C%AF/" data-id="cl4avabv00000ecvk0ox33b17" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-安卓存储栈" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/" class="article-date">
  <time datetime="2022-06-09T13:35:01.000Z" itemprop="datePublished">2022-06-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/">安卓存储栈</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安卓软件栈"><a href="#安卓软件栈" class="headerlink" title="安卓软件栈"></a>安卓软件栈</h3><p><img src="https://developer.android.com/guide/platform/images/android-stack_2x.png?hl=zh-cn" alt="Android 软件堆栈"></p>
<h3 id="framework层"><a href="#framework层" class="headerlink" title="framework层"></a>framework层</h3><p>StorageManager</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/storage/StorageManager.java</span><br></pre></td></tr></table></figure>

<h3 id="java-libcore——位于Android-runtime里的core-libraries"><a href="#java-libcore——位于Android-runtime里的core-libraries" class="headerlink" title="java libcore——位于Android runtime里的core libraries"></a>java libcore——位于Android runtime里的core libraries</h3><blockquote>
<p>According to this slide deck from 2016, Libcore is Google’s implementation of some core Java libraries such as java.net, java.util, java.icu (Unicode), java.math, java.reflect, and possibly more. Libcore also allows for POSIX system calls from Java.Libcore’s master branch can be found here. Most of Google’s implementation is found in folder luni , but libcore also mixes with Oracle code. For example, Oracle’s JNI implementation from OpenJDK is used in Android in folder ojluni. So libcore replaces some functionality from OpenJDK, but not all.<br><strong>有个java.io.file在路径：</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/java/java/io/File.java</span><br></pre></td></tr></table></figure>
<p><strong>framework层是调用上面的这个File.java类吗？不是？</strong></p>
<p>里面有文件相关操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public boolean createNewFile() throws IOException &#123;</span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        if (security != null) security.checkWrite(path);</span><br><span class="line">        if (isInvalid()) &#123;</span><br><span class="line">            throw new IOException(&quot;Invalid file path&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return fs.createFileExclusively(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/* -- File operations -- */</span><br><span class="line">    // Android-changed: Add method to intercept native method call; BlockGuard support.</span><br><span class="line">    public boolean createFileExclusively(String path) throws IOException &#123;</span><br><span class="line">        BlockGuard.getThreadPolicy().onWriteToDisk();</span><br><span class="line">        BlockGuard.getVmPolicy().onPathAccess(path);</span><br><span class="line">        return createFileExclusively0(path);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>这里是C语言实现的给java调用的createFileExclusively0 JNI接口：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/native/UnixFileSystem_md.c：</span><br><span class="line"></span><br><span class="line">// Android-changed: Name changed because of added thread policy check</span><br><span class="line">JNIEXPORT jboolean JNICALL</span><br><span class="line">Java_java_io_UnixFileSystem_createFileExclusively0(JNIEnv *env, jclass cls,</span><br><span class="line">                                                   jstring pathname)</span><br><span class="line">&#123;</span><br><span class="line">    jboolean rv = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    WITH_PLATFORM_STRING(env, pathname, path) &#123;</span><br><span class="line">        FD fd;</span><br><span class="line">        /* The root directory always exists */</span><br><span class="line">        if (strcmp (path, &quot;/&quot;)) &#123;</span><br><span class="line">            fd = handleOpen(path, O_RDWR | O_CREAT | O_EXCL, 0666);</span><br><span class="line">            if (fd &lt; 0) &#123;</span><br><span class="line">                if (errno != EEXIST)</span><br><span class="line">                    JNU_ThrowIOExceptionWithLastError(env, path);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (close(fd) == -1)</span><br><span class="line">                    JNU_ThrowIOExceptionWithLastError(env, path);</span><br><span class="line">                rv = JNI_TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; END_PLATFORM_STRING(env, path);</span><br><span class="line">    return rv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">libcore/ojluni/src/main/native/io_util_md.c：</span><br><span class="line">FD</span><br><span class="line">handleOpen(const char *path, int oflag, int mode) &#123;</span><br><span class="line">    FD fd;</span><br><span class="line">    RESTARTABLE(open64(path, oflag, mode), fd);</span><br><span class="line">    if (fd != -1) &#123;</span><br><span class="line">        struct stat64 buf64;</span><br><span class="line">        int result;</span><br><span class="line">        RESTARTABLE(fstat64(fd, &amp;buf64), result);</span><br><span class="line">        if (result != -1) &#123;</span><br><span class="line">            if (S_ISDIR(buf64.st_mode)) &#123;</span><br><span class="line">                close(fd);</span><br><span class="line">                errno = EISDIR;</span><br><span class="line">                fd = -1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bionic/libc/include/bits/fortify/fcntl.h：</span><br><span class="line">__BIONIC_FORTIFY_INLINE</span><br><span class="line">int open64(const char* const __pass_object_size pathname, int flags, mode_t modes)</span><br><span class="line">        __overloadable</span><br><span class="line">        __clang_warning_if(!__open_modes_useful(flags) &amp;&amp; modes,</span><br><span class="line">                           &quot;&#x27;open64&#x27; &quot; __open_useless_modes_warning) &#123;</span><br><span class="line">    return open(pathname, flags, modes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__BIONIC_FORTIFY_INLINE</span><br><span class="line">int open(const char* const __pass_object_size pathname, int flags, mode_t modes)</span><br><span class="line">        __overloadable</span><br><span class="line">        __clang_warning_if(!__open_modes_useful(flags) &amp;&amp; modes,</span><br><span class="line">                           &quot;&#x27;open&#x27; &quot; __open_useless_modes_warning) &#123;</span><br><span class="line">    return __open_real(pathname, flags, modes);</span><br><span class="line">&#125;</span><br><span class="line">int __open_real(const char*, int, ...) __RENAME(open);</span><br><span class="line"></span><br><span class="line">bionic/libc/include/sys/cdefs.h：</span><br><span class="line">#define __RENAME(x) __asm__(#x)</span><br></pre></td></tr></table></figure>
<p>看这两个文件：<br>libcore\luni\src\main\native\libcore_io_Posix.cpp<br>libcore\luni\src\main\native\libcore_io_Linux.cpp</p>
<p>另外一个类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java：</span><br><span class="line">public class ContextWrapper extends Context &#123;</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    Context mBase;</span><br><span class="line"></span><br><span class="line">    public ContextWrapper(Context base) &#123;</span><br><span class="line">        mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public FileInputStream openFileInput(String name)</span><br><span class="line">            throws FileNotFoundException &#123;</span><br><span class="line">        return mBase.openFileInput(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/ContextImpl.java：</span><br><span class="line"> @Override</span><br><span class="line">    public FileInputStream openFileInput(String name)</span><br><span class="line">        throws FileNotFoundException &#123;</span><br><span class="line">        File f = makeFilename(getFilesDir(), name);</span><br><span class="line">        return new FileInputStream(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">这个对象FileInputStream：</span><br><span class="line">public FileInputStream(String name)</span><br><span class="line">                throws FileNotFoundException</span><br><span class="line">Creates a FileInputStream by opening a connection to an actual file, the file named by the path name name in the file system. A new FileDescriptor object is created to represent this file connection.</span><br><span class="line">其中的几个方法：</span><br><span class="line">public int read() 从输入流读一个字节的数据</span><br><span class="line">         throws IOException</span><br><span class="line">Reads a byte of data from this input stream. This method blocks if no input is yet available.</span><br><span class="line"></span><br><span class="line">public int read(byte[] b)</span><br><span class="line">         throws IOException</span><br><span class="line">Reads up to b.length bytes of data from this input stream into an array of bytes. This method blocks until some input is available.</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">     * Reads up to &lt;code&gt;len&lt;/code&gt; bytes of data from this input stream</span><br><span class="line">     * into an array of bytes. If &lt;code&gt;len&lt;/code&gt; is not zero, the method</span><br><span class="line">     * blocks until some input is available; otherwise, no</span><br><span class="line">     * bytes are read and &lt;code&gt;0&lt;/code&gt; is returned.</span><br><span class="line">     *</span><br><span class="line">     * @param      b     the buffer into which the data is read.</span><br><span class="line">     * @param      off   the start offset in the destination array &lt;code&gt;b&lt;/code&gt;</span><br><span class="line">     * @param      len   the maximum number of bytes read.</span><br><span class="line">     * @return     the total number of bytes read into the buffer, or</span><br><span class="line">     *             &lt;code&gt;-1&lt;/code&gt; if there is no more data because the end of</span><br><span class="line">     *             the file has been reached.</span><br><span class="line">     * @exception  NullPointerException If &lt;code&gt;b&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;.</span><br><span class="line">     * @exception  IndexOutOfBoundsException If &lt;code&gt;off&lt;/code&gt; is negative,</span><br><span class="line">     * &lt;code&gt;len&lt;/code&gt; is negative, or &lt;code&gt;len&lt;/code&gt; is greater than</span><br><span class="line">     * &lt;code&gt;b.length - off&lt;/code&gt;</span><br><span class="line">     * @exception  IOException  if an I/O error occurs.</span><br><span class="line">     */</span><br><span class="line">    public int read(byte b[], int off, int len) throws IOException &#123;</span><br><span class="line">        // Android-added: close() check before I/O.</span><br><span class="line">        if (closed &amp;&amp; len &gt; 0) &#123;</span><br><span class="line">            throw new IOException(&quot;Stream Closed&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Android-added: Tracking of unbuffered I/O.</span><br><span class="line">        tracker.trackIo(len, IoTracker.Mode.READ);</span><br><span class="line"></span><br><span class="line">        // Android-changed: Use IoBridge instead of calling native method.</span><br><span class="line">        return IoBridge.read(fd, b, off, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/native/io_util.c:</span><br><span class="line"></span><br><span class="line">jint</span><br><span class="line">readBytes(JNIEnv *env, jobject this, jbyteArray bytes,</span><br><span class="line">          jint off, jint len, jfieldID fid)</span><br><span class="line">&#123;</span><br><span class="line">    jint nread;</span><br><span class="line">    char stackBuf[BUF_SIZE];</span><br><span class="line">    char *buf = NULL;</span><br><span class="line">    FD fd;</span><br><span class="line"></span><br><span class="line">    if (IS_NULL(bytes)) &#123;</span><br><span class="line">        JNU_ThrowNullPointerException(env, NULL);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (outOfBounds(env, off, len, bytes)) &#123;</span><br><span class="line">        JNU_ThrowByName(env, &quot;java/lang/IndexOutOfBoundsException&quot;, NULL);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (len == 0) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125; else if (len &gt; BUF_SIZE) &#123;</span><br><span class="line">        buf = malloc(len);</span><br><span class="line">        if (buf == NULL) &#123;</span><br><span class="line">            JNU_ThrowOutOfMemoryError(env, NULL);</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        buf = stackBuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = GET_FD(this, fid);</span><br><span class="line">    if (fd == -1) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, &quot;Stream Closed&quot;);</span><br><span class="line">        nread = -1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        nread = (jint)IO_Read(fd, buf, len);</span><br><span class="line">        if (nread &gt; 0) &#123;</span><br><span class="line">            (*env)-&gt;SetByteArrayRegion(env, bytes, off, nread, (jbyte *)buf);</span><br><span class="line">        &#125; else if (nread == JVM_IO_ERR) &#123;</span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, &quot;Read error&quot;);</span><br><span class="line">        &#125; else if (nread == JVM_IO_INTR) &#123;</span><br><span class="line">            JNU_ThrowByName(env, &quot;java/io/InterruptedIOException&quot;, NULL);</span><br><span class="line">        &#125; else &#123; /* EOF */</span><br><span class="line">            nread = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (buf != stackBuf) &#123;</span><br><span class="line">        free(buf);</span><br><span class="line">    &#125;</span><br><span class="line">    return nread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">libcore/ojluni/src/main/native/io_util_md.h:</span><br><span class="line">#define IO_Read JVM_Read</span><br><span class="line"></span><br><span class="line">art/openjdkjvm/OpenjdkJvm.cc:</span><br><span class="line">/* posix read() */</span><br><span class="line">JNIEXPORT jint JVM_Read(jint fd, char* buf, jint nbytes) &#123;</span><br><span class="line">    return TEMP_FAILURE_RETRY(read(fd, buf, nbytes));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>






<h3 id="libc库"><a href="#libc库" class="headerlink" title="libc库"></a>libc库</h3><p>源码位置：<br><code>bionic/libc/stdio/stdio.cpp</code></p>
<p>上层不一定调用fopen，可能直接调open系统调用。<br>例如fopen：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FILE* fopen(const char* file, const char* mode) &#123;</span><br><span class="line">  int mode_flags;</span><br><span class="line">  int flags = __sflags(mode, &amp;mode_flags);</span><br><span class="line">  if (flags == 0) return nullptr;</span><br><span class="line"></span><br><span class="line">  int fd = open(file, mode_flags, DEFFILEMODE);</span><br><span class="line">  if (fd == -1) &#123;</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FILE* fp = __FILE_init(__sfp(), fd, flags);</span><br><span class="line">  if (fp == nullptr) &#123;</span><br><span class="line">    ErrnoRestorer errno_restorer;</span><br><span class="line">    close(fd);</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>里面的open就会最终调用到open系统调用。<br>libc里面调用的系统调用，根据这个文件里的系统调用列表，会用python脚本生成头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//android.googlesource.com/platform/bionic/+/refs/heads/master/libc/SYSCALLS.TXT</span></span><br><span class="line"></span><br><span class="line"># This file is used to automatically generate bionic<span class="number">&#x27;</span>s system call stubs.</span><br><span class="line">#</span><br><span class="line"># Each non-blank, non-comment line has the following format:</span><br><span class="line">#</span><br><span class="line"># return_type func_name[|alias_list][:syscall_name[:socketcall_id]]([parameter_list]) arch_list</span><br><span class="line">#</span><br><span class="line"><span class="meta"># where:</span></span><br><span class="line">#       arch_list ::= <span class="string">&quot;all&quot;</span> | arches</span><br><span class="line"><span class="meta">#       arches    ::= arch |  arch <span class="string">&quot;,&quot;</span> arches</span></span><br><span class="line"><span class="meta">#       arch      ::= <span class="string">&quot;arm&quot;</span> | <span class="string">&quot;arm64&quot;</span> | <span class="string">&quot;x86&quot;</span> | <span class="string">&quot;x86_64&quot;</span> | <span class="string">&quot;lp32&quot;</span> | <span class="string">&quot;lp64&quot;</span></span></span><br><span class="line">#</span><br><span class="line"># Note:</span><br><span class="line">#      - syscall_name corresponds to the name of the syscall, which may differ from</span><br><span class="line"><span class="meta">#        the exported function name (example: the exit syscall is implemented by the _exit()</span></span><br><span class="line"><span class="meta">#        function, which is not the same as the standard C exit() function which calls it)</span></span><br><span class="line">#</span><br><span class="line">#      - alias_list is optional comma separated <span class="built_in">list</span> of function aliases.</span><br><span class="line">#</span><br><span class="line">#      - The call_id parameter, given that func_name and syscall_name have</span><br><span class="line"><span class="meta">#        been provided, allows the user to specify dispatch style syscalls.</span></span><br><span class="line">#        For example, socket() syscall on i386 actually becomes:</span><br><span class="line"><span class="meta">#          socketcall(__NR_socket, 1, *(rest of args on stack)).</span></span><br><span class="line">#</span><br><span class="line">#      - Each parameter type is assumed to be stored in <span class="number">32</span> bits.</span><br><span class="line">#</span><br><span class="line"># This file is processed by a python script named gensyscalls.py, run via</span><br><span class="line"><span class="meta"># genrules in Android.bp.</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/09/%E5%AE%89%E5%8D%93%E5%AD%98%E5%82%A8%E6%A0%88/" data-id="cl472cilf0000dkvk0ufwhatk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Storage/" rel="tag">Storage</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Linux-kernel-news" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/29/Linux-kernel-news/" class="article-date">
  <time datetime="2022-05-29T03:29:12.000Z" itemprop="datePublished">2022-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/29/Linux-kernel-news/">Linux kernel news</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h1><ul>
<li><p>[Linux Storage Linux &amp; Open-Source News - Phoronix](<a target="_blank" rel="noopener" href="https://www.phoronix.com/scan.php?page=news_topic&amp;q=Linux">https://www.phoronix.com/scan.php?page=news_topic&amp;q=Linux</a> Storage) 查看内核storage部分的变化。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://kernelnewbies.org/LinuxVersions">LinuxVersions - Linux Kernel Newbies</a> 查看内核各个版本的差异，其中file system，block layer和drivers的storage跟存储有关。</p>
</li>
<li><p>[LWN.net Weekly Edition Archives <a target="_blank" rel="noopener" href="https://lwn.net/Archives/">LWN.net]</a>, LWN每周的归档，可以查找storage的变化。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/29/Linux-kernel-news/" data-id="cl3qqwrtz0000rwvka8z778x1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storage/" rel="tag">storage</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python建立socket-server-websocket-server" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/27/python%E5%BB%BA%E7%AB%8Bsocket-server-websocket-server/" class="article-date">
  <time datetime="2022-05-27T10:55:26.000Z" itemprop="datePublished">2022-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/27/python%E5%BB%BA%E7%AB%8Bsocket-server-websocket-server/">python建立socket server(websocket server)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装这个库</span><br><span class="line">pip3 install websocket_server</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> websocket_server <span class="keyword">import</span> WebsocketServer</span><br><span class="line"></span><br><span class="line"><span class="comment"># Called for every client connecting (after handshake)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_client</span>(<span class="params">client, server</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;New client connected and was given id %d&quot;</span> % client[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">    server.send_message_to_all(<span class="string">&quot;Hey all, a new client has joined us&quot;</span>)</span><br><span class="line"><span class="comment"># Called for every client disconnecting</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">client_left</span>(<span class="params">client, server</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Client(%d) disconnected&quot;</span> % client[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line"><span class="comment"># Called when a client sends a message</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message_received</span>(<span class="params">client, server, message</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(message) &gt; <span class="number">200</span>:</span><br><span class="line">        message = message[:<span class="number">200</span>]+<span class="string">&#x27;..&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Client(%d) said: %s&quot;</span> % (client[<span class="string">&#x27;id&#x27;</span>], message))</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">server = WebsocketServer(host=<span class="string">&quot;www.lixuewen.ml&quot;</span>, port = <span class="number">10000</span>)</span><br><span class="line">server.set_fn_new_client(new_client)</span><br><span class="line">server.set_fn_client_left(client_left)</span><br><span class="line">server.set_fn_message_received(message_received)</span><br><span class="line">server.run_forever()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/27/python%E5%BB%BA%E7%AB%8Bsocket-server-websocket-server/" data-id="cl3obxdrd0000q8vkcdw016b2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/" rel="tag">socket</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Linux和Windows上面shell基本操作对比" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/25/Linux%E5%92%8CWindows%E4%B8%8A%E9%9D%A2shell%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%AF%B9%E6%AF%94/" class="article-date">
  <time datetime="2022-05-25T09:16:33.000Z" itemprop="datePublished">2022-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/25/Linux%E5%92%8CWindows%E4%B8%8A%E9%9D%A2shell%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%AF%B9%E6%AF%94/">Linux和Windows上面shell基本操作对比</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <table>
<thead>
<tr>
<th></th>
<th>Linux</th>
<th>Windows</th>
</tr>
</thead>
<tbody><tr>
<td>新建目录</td>
<td>mkdir</td>
<td>mkdir</td>
</tr>
<tr>
<td>查看目录下所有文件及目录</td>
<td>ls</td>
<td>dir</td>
</tr>
<tr>
<td>删除文件</td>
<td>rm</td>
<td>del</td>
</tr>
<tr>
<td>删除目录</td>
<td>rm -r</td>
<td>rmdir folder -s</td>
</tr>
<tr>
<td>历史命令</td>
<td>history</td>
<td>F7</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/25/Linux%E5%92%8CWindows%E4%B8%8A%E9%9D%A2shell%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%AF%B9%E6%AF%94/" data-id="cl3mc19p00000l4vk8pidetug" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/">安卓开发</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Arm64/" rel="tag">Arm64</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Busybox/" rel="tag">Busybox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hello-World/" rel="tag">Hello World</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/" rel="tag">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pycharm/" rel="tag">Pycharm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/" rel="tag">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storage/" rel="tag">Storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/adb/" rel="tag">adb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edge/" rel="tag">edge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/for-test/" rel="tag">for test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftpd/" rel="tag">ftpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo%E7%AE%A1%E7%90%86/" rel="tag">hexo管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/httpd/" rel="tag">httpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pyinstaller/" rel="tag">pyinstaller</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/storage/" rel="tag">storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/websocket/" rel="tag">websocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wss/" rel="tag">wss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%9B%98/" rel="tag">网盘</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Arm64/" style="font-size: 10px;">Arm64</a> <a href="/tags/Busybox/" style="font-size: 10px;">Busybox</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">C语言</a> <a href="/tags/Hello-World/" style="font-size: 16.67px;">Hello World</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Javascript/" style="font-size: 10px;">Javascript</a> <a href="/tags/Pycharm/" style="font-size: 10px;">Pycharm</a> <a href="/tags/Python/" style="font-size: 13.33px;">Python</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/Storage/" style="font-size: 10px;">Storage</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/edge/" style="font-size: 10px;">edge</a> <a href="/tags/for-test/" style="font-size: 10px;">for test</a> <a href="/tags/ftpd/" style="font-size: 10px;">ftpd</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo%E7%AE%A1%E7%90%86/" style="font-size: 10px;">hexo管理</a> <a href="/tags/httpd/" style="font-size: 10px;">httpd</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/pyinstaller/" style="font-size: 10px;">pyinstaller</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/storage/" style="font-size: 10px;">storage</a> <a href="/tags/websocket/" style="font-size: 13.33px;">websocket</a> <a href="/tags/wss/" style="font-size: 10px;">wss</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 10px;">杂谈</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 10px;">浏览器</a> <a href="/tags/%E7%BD%91%E7%9B%98/" style="font-size: 10px;">网盘</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/07/17/%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E5%90%8D/">压缩文件夹，同时加密文件名</a>
          </li>
        
          <li>
            <a href="/2022/07/01/Ubuntu%E6%9B%B4%E6%8D%A2%E6%BA%90/">Ubuntu更换源</a>
          </li>
        
          <li>
            <a href="/2022/06/30/qemu%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/22/ufs%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E7%96%91%E9%97%AE/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/11/%E5%AE%89%E5%8D%93%E4%BD%BF%E7%94%A8FUSE/">安卓使用FUSE</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>